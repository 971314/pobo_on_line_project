define(function(require,exports,module){function init(){}function start_init(e,a){var t=businessUtil.getPageId();$(function(){var r=$(t+"#btn1");r.makeThumb({width:500,height:500,success:function(r,i,o,s,n){var l=r.split(",")[1];$(t+".my_page_con").attr("status",1),$(t+"#pictureBase64").val(l),layerUtils.iLoading(!1),$(e).attr("src",r),uploadMobileImg(a)},error:function(e,a,r){layerUtils.iLoading(!1),$(t+".my_page_con").attr("status",0),8==a&&layerUtils.iAlert("上传文件格式不正确，请重新上传",0,function(){})}})})}function uploadMobileImg(callback){var _pageId=businessUtil.getPageId(),userId=common.getUserId();userId||(userId=""),$(_pageId+"#userID").val("view"+userId+(new Date).getTime());var form=$("form[name=form1]"),options={url:gconfig.global.domain+"/servlet/UploadMobileImage?function=SetUserImage",type:"post",success:function(data){var jsondata=eval("("+data+")")[0],realPic=jsondata.Picurl;"ture"==jsondata.result?($(_pageId+".my_page_con").attr("status",0).attr("imgsrc",realPic),callback&&callback()):layerUtils.iAlert(jsondata.message,-1,function(){$(_pageId+".my_page_con").attr("status",0)})}};form.ajaxSubmit(options)}function bindGlobalEvent(){}function destroy(){}var layerUtils=require("layerUtils"),appUtils=require("appUtils"),common=require("common"),businessUtil=require("businessUtil"),gconfig=require("gconfig"),global=gconfig.global;require("futures/scripts/common/plugins/imgcompress/scripts/jquery.make-thumb.js"),require("futures/scripts/common/plugins/form/jquery-form.js"),require("futures/scripts/common/plugins/cropper/canvas-toBlob.js"),require("futures/scripts/common/plugins/cropper/cropper.min.js");var uploadImg={init:init};uploadImg.uploadImg=function(e,a){var t=businessUtil.getPageId();return"1"==$(t+".my_page_con").attr("status")?(layerUtils.iAlert("图片正在上传中...",-1),!1):(setTimeout(function(){start_init(e,a)},200),!0)},uploadImg.uploadImgByCropper=function(e,a,t){var r="#userInfo_setUserInfo ",i='<div id="cropper_area" style="display:none;"><div class="save_area" style="width:100%;height: 0.44rem;position: absolute;top:0;line-height:0.44rem;background-color:#000;z-index:100;color:#fff;font-size: 0.18rem;padding-left:0.1rem;"> <span id="image_save" >保存</span> <span id="image_cancel">取消<span/></div><div class="upload-img" style="width:100%;height: calc(100% - 0.44rem);position: absolute;top:0.44rem;z-index: 1000;"> <img src=""/></div></div>';$(r).append(i);var o=$(r+".upload-img > img");o.cropper({viewMode:1,aspectRatio:1,autoCropArea:.7,crop:function(e){}});var s;return $(r+e).change(function(){layerUtils.iLoading(!0);var e=this.files[0];s=e.name;var a=new FileReader;a.onload=function(){$(r+"#cropper_area").show();var e=a.result;o.cropper("reset",!0).cropper("replace",e),layerUtils.iLoading(!1)},a.readAsDataURL(e)}),appUtils.bindEvent(r+"#image_save",function(){$(r+"#cropper_area").hide();var e=o.attr("src").split(";")[0].split(":")[1],i=o.cropper("getCroppedCanvas",{});$(r+a).attr("src",i.toDataURL()),i.toBlob(function(e){var a=new FormData;a.append("file",e,s),$.ajax({type:"POST",url:gconfig.global.domain+"/servlet/UploadImage?function=SetUserImage",data:a,contentType:!1,processData:!1,dataType:"json",success:function(e){$(r+"#btn1").val(""),e&&"true"==e[0].result?t&&t(e[0].picurl):layerUtils.iAlert("上传失败",-1)},error:function(){layerUtils.iAlert("上传失败",0,function(){$(r+"#btn1").val("")})}})},e)}),appUtils.bindEvent(r+"#image_cancel",function(){$(r+e).val(""),$(r+"#cropper_area").hide()}),!0},module.exports=uploadImg});