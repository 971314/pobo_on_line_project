define(function(t,e,a){!function(){function t(t){var e=t.naturalWidth,a=t.naturalHeight;if(e*a>1048576){var r=document.createElement("canvas");r.width=r.height=1;var i=r.getContext("2d");return i.drawImage(t,-e+1,0),0===i.getImageData(0,0,1,1).data[3]}return!1}function e(t,e,a){var r=document.createElement("canvas");r.width=1,r.height=a;var i=r.getContext("2d");i.drawImage(t,0,0);for(var n=i.getImageData(0,0,1,a).data,o=0,s=a,h=a;h>o;){var c=n[4*(h-1)+3];0===c?s=h:o=h,h=s+o>>1}var g=h/a;return 0===g?1:g}function r(t,e,a){var r=document.createElement("canvas");return i(t,r,e,a),r.toDataURL("image/jpeg",e.quality||.8)}function i(a,r,i,o){var s=a.naturalWidth,h=a.naturalHeight,c=i.width,g=i.height;i.isDebug&&alert("img width:"+s+",img height:"+h+";canvas width:"+c+",canvas height:"+g);var d=r.getContext("2d");d.save(),n(r,c,g,i.orientation);var l=t(a);i.isDebug&&alert("orientation:"+i.orientation+",subsampled:"+l),l&&(s/=2,h/=2);var u=1024,v=document.createElement("canvas");v.width=v.height=u;var w=v.getContext("2d"),m=o?e(a,s,h):1,f=Math.ceil(u*c/s),b=Math.ceil(u*g/h/m),L=0,I=0;for(i.isDebug&&alert("d:"+u+",dw:"+f+",dh"+b+",vertSquashRatio"+m);h>L;){for(var R=0,U=0;s>R;)w.clearRect(0,0,u,u),w.drawImage(a,-R,-L),d.drawImage(v,0,0,u,u,U,I,f,b),R+=u,U+=f;L+=u,I+=b}if(d.restore(),i.isDebug){var p=r.toDataURL(i.type);alert("画板的大小4："+p.length+"B")}v=w=null}function n(t,e,a,r){switch(r){case 5:case 6:case 7:case 8:t.width=a,t.height=e;break;default:t.width=e,t.height=a}var i=t.getContext("2d");switch(r){case 2:i.translate(e,0),i.scale(-1,1);break;case 3:i.translate(e,a),i.rotate(Math.PI);break;case 4:i.translate(0,a),i.scale(1,-1);break;case 5:i.rotate(.5*Math.PI),i.scale(1,-1);break;case 6:i.rotate(.5*Math.PI),i.translate(0,-a);break;case 7:i.rotate(.5*Math.PI),i.translate(e,-a),i.scale(-1,1);break;case 8:i.rotate(-.5*Math.PI),i.translate(-e,0)}}function o(t){if(t instanceof Blob){var e=new Image,a=window.URL&&window.URL.createObjectURL?window.URL:window.webkitURL&&window.webkitURL.createObjectURL?window.webkitURL:null;if(!a)throw Error("No createObjectURL function found to create blob url");e.src=a.createObjectURL(t),this.blob=t,t=e}if(!t.naturalWidth&&!t.naturalHeight){var r=this;t.onload=function(){var t=r.imageLoadListeners;if(t){r.imageLoadListeners=null;for(var e=0,a=t.length;a>e;e++)t[e]()}},this.imageLoadListeners=[]}this.srcImage=t}o.prototype.render=function(t,e){if(this.imageLoadListeners){var a=this;return void this.imageLoadListeners.push(function(){a.render(t,e)})}e=e||{};var n=this.srcImage.naturalWidth,o=this.srcImage.naturalHeight,s=e.width,h=e.height,c=e.maxWidth,g=e.maxHeight,d=!this.blob||"image/jpeg"===this.blob.type;s&&!h?h=o*s/n<<0:h&&!s?s=n*h/o<<0:(s=n,h=o),c&&s>c&&(s=c,h=o*s/n<<0),g&&h>g&&(h=g,s=n*h/o<<0);var l={width:s,height:h};for(var u in e)l[u]=e[u];if(l.isDebug){var v=t.toDataURL(l.type);alert("画板的大小3："+v.length+"B")}var w=t.tagName.toLowerCase();"img"===w?t.src=r(this.srcImage,l,d):"canvas"===w&&i(this.srcImage,t,l,d),"function"==typeof this.onrender&&this.onrender(t)},window.MegaPixImage=o,a.exports={renderImageToDataURL:r}}()});